
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../testing_agents/">
      
      
        <link rel="next" href="../../core/">
      
      
      <link rel="icon" href="../../assets/images/favicon.jpg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Writing Effective Agent Tests - Rustic AI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/theme.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#writing-effective-tests-for-rustic-ai-agents" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Rustic AI Documentation" class="md-header__button md-logo" aria-label="Rustic AI Documentation" data-md-component="logo">
      
  <img src="../../assets/images/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rustic AI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Writing Effective Agent Tests
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/rustic-ai/rustic-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Rustic AI Documentation" class="md-nav__button md-logo" aria-label="Rustic AI Documentation" data-md-component="logo">
      
  <img src="../../assets/images/logo.svg" alt="logo">

    </a>
    Rustic AI Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rustic-ai/rustic-ai" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Light Paper
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            How-To Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../creating_your_first_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating Your First Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../creating_a_guild/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating a Guild
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guild_specifications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guild Specifications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependency_injection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dependency Injection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    State Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing_agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Writing Effective Agent Tests
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Writing Effective Agent Tests
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-testing-patterns-in-rustic-ai" class="md-nav__link">
    <span class="md-ellipsis">
      Key Testing Patterns in Rustic AI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-external-service-agents" class="md-nav__link">
    <span class="md-ellipsis">
      Testing External Service Agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-asynchronous-agents" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Asynchronous Agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-with-external-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with External Dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-agent-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Agent Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-testing-with-probe-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Testing with Probe Agent
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-llm-based-agents" class="md-nav__link">
    <span class="md-ellipsis">
      Testing LLM-based Agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-testing-pitfalls-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Common Testing Pitfalls and Solutions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Testing Pitfalls and Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-race-conditions-in-async-tests" class="md-nav__link">
    <span class="md-ellipsis">
      1. Race Conditions in Async Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-resource-cleanup-in-tests" class="md-nav__link">
    <span class="md-ellipsis">
      2. Resource Cleanup in Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-external-service-dependency" class="md-nav__link">
    <span class="md-ellipsis">
      3. External Service Dependency
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-examples-from-rustic-ai" class="md-nav__link">
    <span class="md-ellipsis">
      Real-World Examples from Rustic AI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agents
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/guilds/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guilds
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/messaging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Messaging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/shared_memory_backend.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shared Memory Backend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Execution
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/multiprocess_execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multiprocess Execution
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dependencies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/state_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    State Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agents
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Agents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/core/guild_manager_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guild Manager Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/core/user_proxy_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    User Proxy Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/core/vector_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vector Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/core/simple_llm_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Simple LLM Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/core/probe_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Probe Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LiteLLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            LiteLLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/litellm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/litellm/litellm_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LiteLLM Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    HuggingFace
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            HuggingFace
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/huggingface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/huggingface/llm_phi_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Phi Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/huggingface/squad_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Squad Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/huggingface/image2image_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Image2Image Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/huggingface/runwayml_stable_diffusion_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runwayml Stable Diffusion Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/huggingface/speecht5_tts_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SpeechT5 TTS Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Playwright
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Playwright
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/playwright/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/playwright/playwright_scraper_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Playwright Scraper Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    SerpAPI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            SerpAPI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/serpapi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/serpapi/serp_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SERP Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Marvin
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Marvin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/marvin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/marvin/marvin_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Marvin Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Dependencies
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Dependencies
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/core/env_secret_provider/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Secret Provider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/core/filesystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File System Resolver
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/core/in_memory_kvstore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    In-Memory KV Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/core/in_process_interpreter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    In-Process Interpreter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/core/python_exec_executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python Exec Executor
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Redis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Redis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/redis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/redis/redis_kvstore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis KV Store
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LiteLLM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            LiteLLM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/litellm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/litellm/litellm_resolver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LiteLLM Resolver
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Chroma
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Chroma
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/chroma/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/chroma/chroma_resolver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chroma Resolver
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LangChain
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            LangChain
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/langchain/character_splitter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Character Splitter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/langchain/openai_embeddings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAI Embeddings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/langchain/recursive_splitter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Recursive Splitter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ray/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ray
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../showcase/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Showcase
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ui_protocol_types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UI Protocol Types
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-testing-patterns-in-rustic-ai" class="md-nav__link">
    <span class="md-ellipsis">
      Key Testing Patterns in Rustic AI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-external-service-agents" class="md-nav__link">
    <span class="md-ellipsis">
      Testing External Service Agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-asynchronous-agents" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Asynchronous Agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-with-external-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with External Dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-agent-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Agent Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-testing-with-probe-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Testing with Probe Agent
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-llm-based-agents" class="md-nav__link">
    <span class="md-ellipsis">
      Testing LLM-based Agents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-testing-pitfalls-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Common Testing Pitfalls and Solutions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Testing Pitfalls and Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-race-conditions-in-async-tests" class="md-nav__link">
    <span class="md-ellipsis">
      1. Race Conditions in Async Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-resource-cleanup-in-tests" class="md-nav__link">
    <span class="md-ellipsis">
      2. Resource Cleanup in Tests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-external-service-dependency" class="md-nav__link">
    <span class="md-ellipsis">
      3. External Service Dependency
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#real-world-examples-from-rustic-ai" class="md-nav__link">
    <span class="md-ellipsis">
      Real-World Examples from Rustic AI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="writing-effective-tests-for-rustic-ai-agents">Writing Effective Tests for Rustic AI Agents<a class="headerlink" href="#writing-effective-tests-for-rustic-ai-agents" title="Permanent link">&para;</a></h1>
<p>This guide provides practical advice and patterns for writing effective tests for Rustic AI agents. It builds on the concepts in the <a href="../testing_agents/">Testing Agents</a> guide, with a focus on real-world testing examples from the Rustic AI codebase.</p>
<h2 id="key-testing-patterns-in-rustic-ai">Key Testing Patterns in Rustic AI<a class="headerlink" href="#key-testing-patterns-in-rustic-ai" title="Permanent link">&para;</a></h2>
<p>When examining tests across the Rustic AI ecosystem (including specialized agents like PlaywrightAgent, SERPAgent, and LiteLLMAgent), several effective patterns emerge:</p>
<ol>
<li><strong>Isolation testing</strong> with <code>wrap_agent_for_testing</code></li>
<li><strong>Integration testing</strong> with probe agents</li>
<li><strong>Targeted dependency mocking</strong> for external service dependencies</li>
<li><strong>Async testing</strong> with <code>asyncio</code> for agents with asynchronous operations</li>
<li><strong>Environment setup and cleanup</strong> using pytest fixtures</li>
<li><strong>Conditional tests</strong> that skip when external service credentials aren't available</li>
</ol>
<h2 id="testing-external-service-agents">Testing External Service Agents<a class="headerlink" href="#testing-external-service-agents" title="Permanent link">&para;</a></h2>
<p>Many Rustic AI agents integrate with external services like APIs, databases, or other tools. Here's a pattern for testing such agents:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.guild.builders</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.messaging.core.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentTag</span><span class="p">,</span> <span class="n">Message</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.utils.priority</span><span class="w"> </span><span class="kn">import</span> <span class="n">Priority</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.utils.basic_class_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_qualified_class_name</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.testing.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrap_agent_for_testing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.your_module.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">YourServiceAgent</span><span class="p">,</span> <span class="n">ServiceRequest</span><span class="p">,</span> <span class="n">ServiceResponse</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestYourServiceAgent</span><span class="p">:</span>
    <span class="c1"># Test with real API if credentials are available</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;YOUR_API_KEY&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;YOUR_API_KEY environment variable not set&quot;</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_with_real_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create and wrap the agent</span>
        <span class="n">agent</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">wrap_agent_for_testing</span><span class="p">(</span>
            <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">YourServiceAgent</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;TestServiceAgent&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="s2">&quot;test_agent&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Test Service Agent&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">build_spec</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Create a test request message</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
            <span class="n">topics</span><span class="o">=</span><span class="s2">&quot;default_topic&quot;</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="n">AgentTag</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;testerId&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tester&quot;</span><span class="p">),</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">get_qualified_class_name</span><span class="p">(</span><span class="n">ServiceRequest</span><span class="p">),</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;param2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">},</span>
            <span class="n">id_obj</span><span class="o">=</span><span class="n">generator</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">Priority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Send the message</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Assert on the results</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">in_response_to</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># Validate the response</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ServiceResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span> <span class="o">==</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># Test with mocked API</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_with_mocked_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Mock the external service</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;your_module.service.Client.call_api&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_api</span><span class="p">:</span>
            <span class="c1"># Configure the mock</span>
            <span class="n">mock_api</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;mocked_data&quot;</span><span class="p">}</span>

            <span class="c1"># Create and wrap the agent</span>
            <span class="n">agent</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">wrap_agent_for_testing</span><span class="p">(</span>
                <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">YourServiceAgent</span><span class="p">)</span>
                <span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;TestServiceAgent&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="s2">&quot;test_agent&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;Test Service Agent&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">build_spec</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="c1"># Create a test request message</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
                <span class="n">topics</span><span class="o">=</span><span class="s2">&quot;default_topic&quot;</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">AgentTag</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;testerId&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tester&quot;</span><span class="p">),</span>
                <span class="nb">format</span><span class="o">=</span><span class="n">get_qualified_class_name</span><span class="p">(</span><span class="n">ServiceRequest</span><span class="p">),</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;param1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;param2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">},</span>
                <span class="n">id_obj</span><span class="o">=</span><span class="n">generator</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">Priority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Send the message</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

            <span class="c1"># Assert the mock was called correctly</span>
            <span class="n">mock_api</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;value2&quot;</span><span class="p">)</span>

            <span class="c1"># Assert on the results</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">ServiceResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mocked_data&quot;</span>
</code></pre></div>
<h2 id="testing-asynchronous-agents">Testing Asynchronous Agents<a class="headerlink" href="#testing-asynchronous-agents" title="Permanent link">&para;</a></h2>
<p>For agents that perform asynchronous operations (like web scraping or API calls), your tests need to account for the asynchronous nature:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.guild.builders</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.testing.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrap_agent_for_testing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.your_module.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncAgent</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestAsyncAgent</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>  <span class="c1"># Requires pytest-asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_async_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
        <span class="c1"># Create and wrap the agent</span>
        <span class="n">agent</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">wrap_agent_for_testing</span><span class="p">(</span>
            <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">AsyncAgent</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;TestAsyncAgent&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="s2">&quot;test_agent&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">build_spec</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Create and send a test message</span>
        <span class="c1"># ... code to create message ...</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># Wait for async operations to complete</span>
        <span class="c1"># This is important! We need to give the async operations time to run</span>
        <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Wait a bit</span>
            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Exit when we get the expected results or timeout</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Now perform assertions</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c1"># ... more specific assertions ...</span>
</code></pre></div>
<h2 id="testing-with-external-dependencies">Testing with External Dependencies<a class="headerlink" href="#testing-with-external-dependencies" title="Permanent link">&para;</a></h2>
<p>Agents often depend on external services. You can inject mock or real dependencies during testing:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.guild.agent_ext.depends.dependency_resolver</span><span class="w"> </span><span class="kn">import</span> <span class="n">DependencySpec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.testing.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">wrap_agent_for_testing</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_agent_with_dependencies</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
    <span class="c1"># Define test dependencies</span>
    <span class="n">filesystem</span> <span class="o">=</span> <span class="n">DependencySpec</span><span class="p">(</span>
        <span class="n">class_name</span><span class="o">=</span><span class="s2">&quot;rustic_ai.core.guild.agent_ext.depends.filesystem.FileSystemResolver&quot;</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;path_base&quot;</span><span class="p">:</span> <span class="s2">&quot;/tmp/test&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_options&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;auto_mkdir&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Create and wrap the agent with dependencies</span>
    <span class="n">agent</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">wrap_agent_for_testing</span><span class="p">(</span>
        <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">YourAgent</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="s2">&quot;test_agent&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;TestAgent&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">build_spec</span><span class="p">(),</span>
        <span class="p">{</span><span class="s2">&quot;filesystem&quot;</span><span class="p">:</span> <span class="n">filesystem</span><span class="p">},</span>  <span class="c1"># Inject dependencies here</span>
    <span class="p">)</span>

    <span class="c1"># Create and send a test message</span>
    <span class="c1"># ... code to create and send message ...</span>

    <span class="c1"># You can even access and test the injected dependency</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">to_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">guild_id</span><span class="p">,</span> <span class="s2">&quot;GUILD_GLOBAL&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">some_path</span><span class="p">)</span>
</code></pre></div>
<h2 id="testing-agent-error-handling">Testing Agent Error Handling<a class="headerlink" href="#testing-agent-error-handling" title="Permanent link">&para;</a></h2>
<p>Good agent tests not only verify correct behavior but also proper error handling:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_error_handling</span><span class="p">():</span>
    <span class="c1"># Create and wrap the agent</span>
    <span class="n">agent</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">wrap_agent_for_testing</span><span class="p">(</span>
        <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">YourAgent</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;TestAgent&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="s2">&quot;test_agent&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">build_spec</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># 1. Test with invalid input</span>
    <span class="n">invalid_message</span> <span class="o">=</span> <span class="n">create_message_with_invalid_payload</span><span class="p">()</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">invalid_message</span><span class="p">)</span>

    <span class="c1"># Verify agent produces appropriate error response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_error_message</span>
    <span class="k">assert</span> <span class="s2">&quot;Invalid input&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Test when a dependency fails</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;some_dependency.method&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_dep</span><span class="p">:</span>
        <span class="n">mock_dep</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Dependency failed&quot;</span><span class="p">)</span>

        <span class="n">results</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear previous results</span>
        <span class="n">valid_message</span> <span class="o">=</span> <span class="n">create_valid_message</span><span class="p">()</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">valid_message</span><span class="p">)</span>

        <span class="c1"># Verify agent handles dependency failure gracefully</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_error_message</span>
        <span class="k">assert</span> <span class="s2">&quot;Dependency failed&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="integration-testing-with-probe-agent">Integration Testing with Probe Agent<a class="headerlink" href="#integration-testing-with-probe-agent" title="Permanent link">&para;</a></h2>
<p>The <code>ProbeAgent</code> is a powerful tool for testing agent interactions within a guild:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.agents.testutils.probe_agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbeAgent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.guild.builders</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentBuilder</span><span class="p">,</span> <span class="n">GuildBuilder</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_guild</span><span class="p">():</span>
    <span class="c1"># Create a guild for testing</span>
    <span class="n">guild</span> <span class="o">=</span> <span class="n">GuildBuilder</span><span class="p">(</span><span class="s2">&quot;test_guild&quot;</span><span class="p">,</span> <span class="s2">&quot;Test Guild&quot;</span><span class="p">,</span> <span class="s2">&quot;Guild for testing&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">add_probe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Add your test agents</span>
    <span class="n">agent1_spec</span> <span class="o">=</span> <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">Agent1Class</span><span class="p">)</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Agent1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build_spec</span><span class="p">()</span>
    <span class="n">agent2_spec</span> <span class="o">=</span> <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">Agent2Class</span><span class="p">)</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Agent2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">build_spec</span><span class="p">()</span>

    <span class="n">guild</span><span class="o">.</span><span class="n">launch_agent</span><span class="p">(</span><span class="n">agent1_spec</span><span class="p">)</span>
    <span class="n">guild</span><span class="o">.</span><span class="n">launch_agent</span><span class="p">(</span><span class="n">agent2_spec</span><span class="p">)</span>

    <span class="c1"># Get the probe agent</span>
    <span class="n">probe_agent</span><span class="p">:</span> <span class="n">ProbeAgent</span> <span class="o">=</span> <span class="n">guild</span><span class="o">.</span><span class="n">_add_local_agent</span><span class="p">(</span><span class="n">probe_spec</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Return guild and probe agent</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">guild</span><span class="p">,</span> <span class="n">probe_agent</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Always clean up</span>
        <span class="n">guild</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_agent_interaction</span><span class="p">(</span><span class="n">test_guild</span><span class="p">):</span>
    <span class="n">guild</span><span class="p">,</span> <span class="n">probe_agent</span> <span class="o">=</span> <span class="n">test_guild</span>

    <span class="c1"># Send an initial message to trigger interaction</span>
    <span class="n">probe_agent</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;default_topic&quot;</span><span class="p">,</span> <span class="n">StartMessage</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">))</span>

    <span class="c1"># Wait for messages to be processed</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Get all messages captured by the probe</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">probe_agent</span><span class="o">.</span><span class="n">get_messages</span><span class="p">()</span>

    <span class="c1"># Verify the correct sequence of interactions</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;agent1&quot;</span>
    <span class="k">assert</span> <span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;agent2&quot;</span>
    <span class="c1"># ... more detailed assertions about message content ...</span>
</code></pre></div>
<h2 id="testing-llm-based-agents">Testing LLM-based Agents<a class="headerlink" href="#testing-llm-based-agents" title="Permanent link">&para;</a></h2>
<p>For agents that use language models (like LiteLLMAgent), you can use the mock_response pattern:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">rustic_ai.core.guild.agent_ext.depends.llm.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ChatCompletionRequest</span><span class="p">,</span> <span class="n">SystemMessage</span><span class="p">,</span> <span class="n">UserMessage</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_llm_agent</span><span class="p">(</span><span class="n">probe_agent</span><span class="p">,</span> <span class="n">guild</span><span class="p">):</span>
    <span class="c1"># Create and add the LLM agent to the guild</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">AgentBuilder</span><span class="p">(</span><span class="n">LLMAgent</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s2">&quot;Test LLM Agent&quot;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">set_id</span><span class="p">(</span><span class="s2">&quot;llm_agent&quot;</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">build_spec</span><span class="p">()</span>

    <span class="n">guild</span><span class="o">.</span><span class="n">_add_local_agent</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>

    <span class="c1"># Create a request with a mock response to avoid real API calls</span>
    <span class="n">chat_completion_request</span> <span class="o">=</span> <span class="n">ChatCompletionRequest</span><span class="p">(</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">UserMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;What is the capital of France?&quot;</span><span class="p">)],</span>
        <span class="n">mock_response</span><span class="o">=</span><span class="s2">&quot;The capital of France is Paris.&quot;</span><span class="p">,</span>  <span class="c1"># Mock response</span>
    <span class="p">)</span>

    <span class="c1"># Send the request</span>
    <span class="n">probe_agent</span><span class="o">.</span><span class="n">publish_dict</span><span class="p">(</span>
        <span class="n">guild</span><span class="o">.</span><span class="n">DEFAULT_TOPIC</span><span class="p">,</span>
        <span class="n">chat_completion_request</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="n">ChatCompletionRequest</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Wait for processing</span>

    <span class="c1"># Check the results</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">probe_agent</span><span class="o">.</span><span class="n">get_messages</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="s2">&quot;Paris&quot;</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;choices&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</code></pre></div>
<h2 id="common-testing-pitfalls-and-solutions">Common Testing Pitfalls and Solutions<a class="headerlink" href="#common-testing-pitfalls-and-solutions" title="Permanent link">&para;</a></h2>
<h3 id="1-race-conditions-in-async-tests">1. Race Conditions in Async Tests<a class="headerlink" href="#1-race-conditions-in-async-tests" title="Permanent link">&para;</a></h3>
<p><strong>Problem</strong>: Tests sometimes pass, sometimes fail due to timing issues.</p>
<p><strong>Solution</strong>: Use <code>asyncio.sleep()</code> with retries to wait for operations to complete:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Instead of a fixed sleep time:</span>
<span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Exit condition based on expected state</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Timeout after 10 tries</span>
        <span class="k">break</span>
</code></pre></div>
<h3 id="2-resource-cleanup-in-tests">2. Resource Cleanup in Tests<a class="headerlink" href="#2-resource-cleanup-in-tests" title="Permanent link">&para;</a></h3>
<p><strong>Problem</strong>: Tests leave behind resources that affect other tests.</p>
<p><strong>Solution</strong>: Use pytest fixtures with cleanup:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">resource_fixture</span><span class="p">():</span>
    <span class="c1"># Setup</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">create_resource</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">resource</span>  <span class="c1"># Provide the resource to the test</span>

    <span class="c1"># Cleanup (always runs, even if test fails)</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</code></pre></div>
<h3 id="3-external-service-dependency">3. External Service Dependency<a class="headerlink" href="#3-external-service-dependency" title="Permanent link">&para;</a></h3>
<p><strong>Problem</strong>: Tests fail when run without access to external services.</p>
<p><strong>Solution</strong>: Use <code>pytest.mark.skipif</code> to conditionally skip tests:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skipif</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REQUIRED_API_KEY&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;API key not available&quot;</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_with_external_service</span><span class="p">():</span>
    <span class="c1"># Test that requires external service</span>
</code></pre></div>
<h2 id="best-practices-summary">Best Practices Summary<a class="headerlink" href="#best-practices-summary" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>Parametrize Common Tests</strong>: Use <code>@pytest.mark.parametrize</code> to run the same test with different inputs.</p>
</li>
<li>
<p><strong>Keep Dependencies Consistent</strong>: Use the same dependency structure in tests as in production code.</p>
</li>
<li>
<p><strong>Test Failure Modes</strong>: Don't just test the happy path; test how your agent handles errors.</p>
</li>
<li>
<p><strong>Mock External Services</strong>: Use <code>unittest.mock.patch</code> to replace external API calls.</p>
</li>
<li>
<p><strong>Combine Unit and Integration Tests</strong>: Test components in isolation first, then together.</p>
</li>
<li>
<p><strong>Use Descriptive Test Names</strong>: Make your test names describe the behavior being tested.</p>
</li>
<li>
<p><strong>Isolate Test State</strong>: Ensure tests don't interfere with each other's state.</p>
</li>
</ol>
<h2 id="real-world-examples-from-rustic-ai">Real-World Examples from Rustic AI<a class="headerlink" href="#real-world-examples-from-rustic-ai" title="Permanent link">&para;</a></h2>
<p>To see these patterns in action, examine the test suites for these agents:</p>
<ol>
<li><strong>PlaywrightAgent</strong>: Tests asynchronous web scraping with injected filesystem dependency</li>
<li><strong>SERPAgent</strong>: Tests API calls with both real and mocked services</li>
<li><strong>LiteLLMAgent</strong>: Tests LLM integration with mock responses</li>
</ol>
<p>These examples demonstrate how to effectively test agents with different requirements and complexity levels.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>Effective testing is crucial for building reliable agent-based systems. By following these patterns and guidelines, you can create tests that validate your agents' behavior, handle edge cases, and catch regressions early. Remember that good tests not only verify that the right thing happens when the right input is provided, but also that the right thing happens when something goes wrong. </p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>